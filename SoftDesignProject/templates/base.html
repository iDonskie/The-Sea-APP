<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SEA - Student's Emporium for All</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Global Navigation Styles */
    * { box-sizing: border-box; }
    
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      line-height: 1.6;
      color: #333;
    }
    
    .main-content {
      min-height: calc(100vh - 80px);
      padding-top: 0;
    }
    
    .navbar {
      background: white;
      padding: 12px 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-bottom: 1px solid #e9ecef;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .nav-brand {
      font-size: 1.8rem;
      font-weight: 800;
      color: #667eea;
      text-decoration: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .nav-brand:hover {
      text-decoration: none;
      opacity: 0.8;
    }
    
    .nav-links {
      display: flex;
      align-items: center;
      gap: 0;
      flex: 1;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .nav-links a {
      color: #495057;
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .nav-links a:hover {
      background: #f8f9fa;
      color: #667eea;
      text-decoration: none;
    }
    
    .nav-links a.active {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .nav-user {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .user-info {
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .nav-user a {
      color: #495057;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 500;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .nav-user a.btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    
    .nav-user a.btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      text-decoration: none;
      color: white;
    }
    
    .nav-user a.btn-outline {
      border: 1px solid #667eea;
      color: #667eea;
    }
    
    .nav-user a.btn-outline:hover {
      background: #667eea;
      color: white;
      text-decoration: none;
    }
    
    .nav-user a.btn-logout {
      color: #dc3545;
      border: 1px solid #dc3545;
    }
    
    .nav-user a.btn-logout:hover {
      background: #dc3545;
      color: white;
      text-decoration: none;
    }
    
    /* Mobile Navigation */
    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #495057;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .nav-container {
        padding: 0 15px;
      }
      
      .nav-links {
        display: none;
        width: 100%;
        flex-direction: column;
        gap: 5px;
        margin-top: 15px;
      }
      
      .nav-links.active {
        display: flex;
      }
      
      .nav-links a {
        width: 100%;
        text-align: center;
        padding: 12px;
        border-radius: 8px;
      }
      
      .mobile-toggle {
        display: block;
      }
      
      .nav-user {
        gap: 10px;
      }
      
      .nav-user a {
        padding: 6px 12px;
        font-size: 0.9rem;
      }
    }
    
    @media (max-width: 480px) {
      .nav-brand {
        font-size: 1.5rem;
      }
      
      .user-info {
        display: none;
      }
    }
  </style>
</head>
<body data-user-id="{% if session.get('user_id') %}{{ session.get('user_id') }}{% endif %}"{% if other %} data-other-id="{{ other['student_id'] }}"{% endif %}>
<nav class="navbar">
  <div class="nav-container">
    <a href="{{ url_for('home') }}" class="nav-brand">SEA</a>
    
    <button class="mobile-toggle" onclick="toggleMobileNav()">‚ò∞</button>
    
    <div class="nav-links" id="navLinks">
      <a href="{{ url_for('home') }}">üè† Home</a>
      <a href="{{ url_for('marketplace') }}">üõí Marketplace</a>
      <a href="{{ url_for('messages') }}">üí¨ Messages</a>
      {% if session.get('user_id') %}
        <a href="{{ url_for('my_listings') }}">üìù My Listings</a>
        <a href="{{ url_for('add_item') }}">‚ûï Sell Item</a>
        {% if is_admin_user %}
          <a href="{{ url_for('admin_dashboard') }}" style="color: #dc3545; font-weight: bold;">üõ°Ô∏è Admin</a>
        {% endif %}
      {% endif %}
    </div>
    
    <div class="nav-user">
      {% if session.get('user_id') %}
        <span class="user-info">üëã {{ session.get('user_name') }}</span>
        <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn-outline">Login</a>
        <a href="{{ url_for('register') }}" class="btn-primary">Register</a>
      {% endif %}
    </div>
  </div>
</nav>

<script>
function toggleMobileNav() {
  const navLinks = document.getElementById('navLinks');
  navLinks.classList.toggle('active');
}

// Close mobile nav when clicking outside
document.addEventListener('click', function(e) {
  const navLinks = document.getElementById('navLinks');
  const mobileToggle = document.querySelector('.mobile-toggle');
  
  if (!navLinks.contains(e.target) && !mobileToggle.contains(e.target)) {
    navLinks.classList.remove('active');
  }
});
</script>

<div class="main-content">
{% block content %}{% endblock %}
</div>

<!-- Chat widget (global, available on every page) -->
<style>
  .chat-widget{position:fixed;right:18px;bottom:18px;width:320px;max-height:420px;box-shadow:0 8px 20px rgba(0,0,0,0.12);border-radius:10px;overflow:hidden;font-family:Segoe UI,Roboto,Arial;z-index:9999;background:#fff;border:1px solid #e6e6e6;display:flex;flex-direction:column}
  .chat-header{background:#007bff;color:#fff;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
  .chat-header .title{font-weight:700;font-size:0.95rem}
  .chat-body{flex:1;padding:10px;overflow:auto;background:#f9fbff}
  .chat-message{margin-bottom:8px;max-width:80%;}
  .chat-message.me{margin-left:auto;background:#007bff;color:#fff;padding:8px 10px;border-radius:10px;}
  .chat-message.them{background:#fff;padding:8px 10px;border-radius:10px;border:1px solid #e6e6e6;color:#222;}
  .chat-input{display:flex;border-top:1px solid #eee;padding:8px;background:#fff}
  .chat-input input{flex:1;padding:8px;border:1px solid #ddd;border-radius:6px;margin-right:8px}
  .chat-input button{background:#007bff;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .chat-minimized{position:fixed;right:18px;bottom:18px;background:#007bff;color:#fff;padding:10px 14px;border-radius:28px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.12);z-index:9999;display:none}
  .chat-widget{display:none}
  .chat-hidden{visibility:hidden !important}
  @media(max-width:420px){ .chat-widget{width:92%;right:4%;bottom:12px} }
</style>

<!-- Hide chat widget on chat pages -->
{% set is_chat_page = request.endpoint == 'chat_page' %}

{% if session.get('user_id') %}
<div id="chatMin" class="chat-minimized{% if is_chat_page %} chat-hidden{% endif %}" onclick="toggleChat(true)">Chat</div>

<div id="chatWidget" class="chat-widget{% if is_chat_page %} chat-hidden{% endif %}" role="dialog" aria-label="Chat">
  <div class="chat-header">
    <div class="title" id="chatTitle">Chat</div>
    <div>
      <button onclick="toggleChat(false)" title="Minimize" style="background:transparent;border:0;color:#fff;cursor:pointer">_</button>
      <button onclick="closeChat()" title="Close" style="background:transparent;border:0;color:#fff;cursor:pointer">√ó</button>
    </div>
  </div>
  <div class="chat-body" id="chatBody"></div>
  <div class="chat-input">
    <input type="file" id="chatImageInput" accept="image/*" style="display:none" onchange="sendImageMessage(this)">
    <button onclick="document.getElementById('chatImageInput').click()" title="Send Image" style="background:#28a745;color:#fff;border:0;padding:8px;border-radius:6px;margin-right:5px;cursor:pointer">üì∑</button>
    <input id="chatInput" placeholder="Type a message..." autocomplete="off" style="flex:1;margin-right:5px">
    <button id="chatSend">Send</button>
  </div>
</div>

<script>
  let currentChatId = null;
  let chatPoll = null;
  // Get user ID from data attribute
  const CHAT_ME_ID = document.body.dataset.userId ? parseInt(document.body.dataset.userId) : null;

  function isOnChatPage() {
    // Check if we're on a chat page (/chat/*)
    return window.location.pathname.startsWith('/chat/');
  }

  function _showChat(name){
    // Don't show chat widget if we're already on a chat page
    if (isOnChatPage()) return;
    
    document.getElementById('chatTitle').textContent = name || 'Chat';
    document.getElementById('chatWidget').style.display = 'flex';
    document.getElementById('chatMin').style.display = 'none';
  }

  function openChat(otherId, name){
    if(!otherId) return;
    
    // If we're on a chat page, navigate to the new chat instead of opening widget
    if (isOnChatPage()) {
      window.location.href = '/chat/' + otherId;
      return;
    }
    
    currentChatId = Number(otherId);
    localStorage.setItem('sea_chat', JSON.stringify({id: currentChatId, name: name || 'Chat'}));
    _showChat(name);
    loadMessages(true);
    if(chatPoll) clearInterval(chatPoll);
    chatPoll = setInterval(()=> loadMessages(false), 2500);
    const input = document.getElementById('chatInput'); if(input) input.focus();
  }

  function closeChat(){
    document.getElementById('chatWidget').style.display = 'none';
    document.getElementById('chatMin').style.display = 'block';
    if(chatPoll){ clearInterval(chatPoll); chatPoll = null; }
    currentChatId = null;
    localStorage.removeItem('sea_chat');
  }

  function toggleChat(open){
    // Don't allow chat widget on chat pages
    if (isOnChatPage()) return;
    
    if(open){ document.getElementById('chatWidget').style.display='flex'; document.getElementById('chatMin').style.display='none'; }
    else { document.getElementById('chatWidget').style.display='none'; document.getElementById('chatMin').style.display='block'; }
  }

  async function loadMessages(scrollToBottom=true){
    if(!currentChatId) return;
    try{
      const res = await fetch(`/chat/${currentChatId}/messages`);
      if(!res.ok) return;
      const msgs = await res.json();
      const body = document.getElementById('chatBody');
      body.innerHTML = '';
      msgs.forEach(m=>{
        const el = document.createElement('div');
        el.className = 'chat-message ' + (m.sender_id === CHAT_ME_ID ? 'me' : 'them');
        el.style.position = 'relative';
        
        // Add message controls for own messages
        if(m.sender_id === CHAT_ME_ID) {
          const controls = document.createElement('div');
          controls.className = 'message-controls';
          controls.style.cssText = `
            position: absolute; top: -8px; right: -8px; 
            background: rgba(0,0,0,0.7); border-radius: 12px; 
            padding: 2px; display: none;
          `;
          
          if(m.message_type !== 'image') {
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.style.cssText = 'background: none; border: none; color: white; cursor: pointer; padding: 2px 4px; font-size: 12px;';
            editBtn.onclick = () => editMessage(m.id, m.content);
            controls.appendChild(editBtn);
          }
          
          const deleteBtn = document.createElement('button');
          deleteBtn.innerHTML = 'üóëÔ∏è';
          deleteBtn.style.cssText = 'background: none; border: none; color: white; cursor: pointer; padding: 2px 4px; font-size: 12px;';
          deleteBtn.onclick = () => deleteMessage(m.id);
          controls.appendChild(deleteBtn);
          
          el.appendChild(controls);
          
          // Show controls on hover
          el.onmouseenter = () => controls.style.display = 'block';
          el.onmouseleave = () => controls.style.display = 'none';
        }
        
        const contentEl = document.createElement('div');
        contentEl.id = `message-content-${m.id}`;
        
        if(m.message_type === 'image' && m.image_attachment) {
          // Create image message
          contentEl.innerHTML = `
            <div style="margin-bottom: 5px;">${m.content}</div>
            <img src="/static/uploads/${m.image_attachment}" 
                 alt="Shared image" 
                 style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;"
                 onclick="openImagePreview('${m.image_attachment}')">
          `;
        } else {
          // Text message
          contentEl.textContent = m.content;
        }
        
        // Add edited indicator if message was edited
        if(m.edited && m.message_type !== 'image') {
          const editedSpan = document.createElement('span');
          editedSpan.style.cssText = 'font-size: 0.75em; opacity: 0.7; margin-left: 5px; font-style: italic;';
          editedSpan.textContent = '(edited)';
          contentEl.appendChild(editedSpan);
        }
        
        el.appendChild(contentEl);
        body.appendChild(el);
      });
      if(scrollToBottom) body.scrollTop = body.scrollHeight;
    }catch(e){ console.error('loadMessages', e); }
  }

  function sendMessage(){
    const textEl = document.getElementById('chatInput');
    const text = (textEl.value || '').trim();
    if(!text || !currentChatId) return;
    fetch(`/chat/${currentChatId}/messages`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({content: text})
    }).then(res=>{
      if(res.ok){ textEl.value = ''; loadMessages(true); }
      else res.text().then(t=> console.error('send failed', res.status, t));
    }).catch(e=> console.error('send error', e));
  }

  function sendImageMessage(inputEl) {
    const file = inputEl.files[0];
    if (!file || !currentChatId) return;
    
    const formData = new FormData();
    formData.append('image', file);
    
    fetch(`/chat/${currentChatId}/messages`, {
      method: 'POST',
      body: formData
    }).then(res => {
      if (res.ok) {
        inputEl.value = ''; // Clear the file input
        loadMessages(true);
      } else {
        res.text().then(t => console.error('image send failed', res.status, t));
      }
    }).catch(e => console.error('image send error', e));
  }

  function editMessage(messageId, currentContent) {
    const newContent = prompt('Edit your message:', currentContent);
    if (newContent === null || newContent.trim() === '') return;
    
    fetch(`/chat/message/${messageId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: newContent.trim() })
    }).then(res => {
      if (res.ok) {
        loadMessages(false);
      } else {
        res.json().then(data => alert(data.error || 'Failed to edit message'));
      }
    }).catch(e => {
      console.error('Edit message error:', e);
      alert('Error editing message');
    });
  }
  
  function deleteMessage(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) return;
    
    fetch(`/chat/message/${messageId}`, {
      method: 'DELETE'
    }).then(res => {
      if (res.ok) {
        loadMessages(false);
      } else {
        res.json().then(data => alert(data.error || 'Failed to delete message'));
      }
    }).catch(e => {
      console.error('Delete message error:', e);
      alert('Error deleting message');
    });
  }

  function openImagePreview(filename) {
    // Create a simple image preview modal
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; 
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    `;
    
    const img = document.createElement('img');
    img.src = `/static/uploads/${filename}`;
    img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
    
    modal.appendChild(img);
    document.body.appendChild(modal);
    
    modal.onclick = () => document.body.removeChild(modal);
  }

  // delegated handler: open widget and persist. allow normal navigation when href is a real link.
  document.addEventListener('click', function(evt){
    const el = evt.target.closest('.open-chat');
    if(!el) return;
    const href = el.getAttribute('href');
    const other = el.getAttribute('data-other');
    const name = el.getAttribute('data-name') || el.textContent.trim();
    // persist + open widget
    localStorage.setItem('sea_chat', JSON.stringify({id: other, name}));
    openChat(other, name);
    // only prevent default if link is inert (# or javascript)
    if(!href || href === '#' || href.trim().toLowerCase().startsWith('javascript:')) {
      evt.preventDefault();
    }
    // otherwise allow navigation (user will go to full chat page)
  });

  document.addEventListener('DOMContentLoaded', function(){
    // Don't restore chat widget if we're on a chat page
    if (isOnChatPage()) return;
    
    // restore saved chat when switching pages
    const saved = localStorage.getItem('sea_chat');
    if(saved){
      try{
        const obj = JSON.parse(saved);
        if(obj && obj.id){
          currentChatId = Number(obj.id);
          _showChat(obj.name || 'Chat');
          loadMessages(true);
          chatPoll = setInterval(()=> loadMessages(false), 2500);
        }
      }catch(e){}
    }
    const send = document.getElementById('chatSend');
    const input = document.getElementById('chatInput');
    if(send && input){
      send.addEventListener('click', sendMessage);
      input.addEventListener('keypress', function(e){ if(e.key === 'Enter') sendMessage(); });
    }
  });

  window.addEventListener('beforeunload', ()=> { if(chatPoll) clearInterval(chatPoll); });
</script>
{% endif %}

</body>
</html>