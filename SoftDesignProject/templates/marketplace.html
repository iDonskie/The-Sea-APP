{% extends "base.html" %}
{% block content %}
<style>
  .listing-list{max-width:900px;margin:18px auto;padding:0 12px;font-family:Segoe UI,Roboto,Arial;}
  .listing-item{border-bottom:1px solid #eee;padding:14px 0;display:flex;gap:14px;align-items:flex-start;}
  .listing-thumb{width:180px;flex-shrink:0;}
  .listing-thumb img{max-width:100%;border-radius:6px;border:1px solid #ddd;}
  .listing-body{flex:1;}
  .listing-actions{margin-top:8px;display:flex;gap:8px;align-items:center;}
  .btn-primary{background:#007bff;color:#fff;padding:8px 12px;border-radius:6px;text-decoration:none;display:inline-block}
  @media(max-width:640px){ .listing-item{flex-direction:column;} .listing-thumb{width:100%;} }
</style>

<div class="listing-list">
  <h1>Marketplace</h1>
  <p><a href="{{ url_for('add_item') }}">Add new item</a></p>

  {% if items %}
    {% for it in items %}
      <div class="listing-item">
        <div class="listing-thumb">
          {% if it['image'] %}
            <img src="{{ url_for('static', filename='uploads/' ~ it['image']) }}" alt="{{ it['item_name'] }}">
          {% else %}
            <img src="{{ url_for('static', filename='placeholder.png') }}" alt="No image">
          {% endif %}
        </div>

        <div class="listing-body">
          <div class="listing-title">{{ it['item_name'] }} â€” {{ it['price']|php }}</div>
          <div class="listing-meta">
            <em>Status: {{ it['status'] or 'available' }}</em><br>
            <small>Seller: {{ it['seller_name'] or it['student_id'] }}</small>
          </div>

          <div class="listing-actions">
            {% if session.get('user_id') and session.get('user_id') == it['student_id'] %}
              <a class="btn-primary" href="{{ url_for('edit_listing', item_id=it['item_id']) }}">Edit</a>
            {% else %}
              <!-- link to full chat page but also has .open-chat to open widget -->
              <a class="btn-primary open-chat"
                 href="{{ url_for('chat_page', other_id=it['student_id']) }}"
                 data-other="{{ it['student_id'] }}"
                 data-name="{{ (it['seller_name'] or 'Seller')|e }}">
                Message seller
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p>No items yet.</p>
  {% endif %}
</div>
{% endblock %}